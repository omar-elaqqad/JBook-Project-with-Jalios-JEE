(function(A,F,i,l){let logPrefix="[directory-app-esn-expertises]";let PARAM_NAME_COMPETENCE_ID="competenceSearch_competenceId";let PARAM_OP_SEARCH="competenceSearch_opSearch";let initDone=false;const j=function(){if(initDone){return}initDone=true;A(i).on("jalios:refresh",t);q();I();s();E()};const q=function(){let $cards=A(".card.esn-competencies-item-category");J(logPrefix,"[initCompetenceCards]",$cards,arguments.callee);$cards.each(function(K){let $e=A(this);let cardTitle=$e.data("esn-directory-filter-expertise-title");$e.attr("data-toggle","tooltip");$e.attr("data-placement","top");if(cardTitle&&!$e.attr("title")){$e.attr("title",cardTitle);$e.removeAttr("data-esn-directory-filter-expertise-title")}});g()};const g=function(){if(A.plugin&&A.plugin.DirectoryApp&&typeof(A.plugin.DirectoryApp.initTooltips)==="function"){A.plugin.DirectoryApp.initTooltips()}};const I=function(){A(i).on("click keydown",".card.esn-competencies-item:not(.esn-competencies-item-new-category)",d);A(i).on("click keydown",".esn-competencies-item .js-filter-expertise",d);A(i).on("select-expertise",b);A(i).on("click keydown",C);A(i).on("contextmenu",".esn-competencies-item-category",B);A(".esn-competencies-item-category").mousedown(function(K){K.preventDefault()});A(i).on("click keydown","[data-jalios-competence-action]",k);A(i).on("click keydown",".esn-competencies-item-new-category",function(K){if(!A.plugin.DirectoryUI.isFocusedClick(K)){return}A(K.currentTarget).find("[data-jalios-competence-action]").click()});A(i).on("click keydown",".esn-competencies-item .js-activate-card",v);A(i).on("click keydown",".esn-directory-explore-breadcrumb .breadcrumb-item",p);A(i).on("click keydown",".expertise-filters .category-filter-item-remove",u)};const s=function(){A(i).on("mouseover",".card.esn-competencies-item .js-activate-card",x);A(i).on("mouseout",".card.esn-competencies-item .js-activate-card",a)};const x=function(K){let $card=A(this).closest(".card");let $cardTooltip=$card.next("DIV.tooltip");if($cardTooltip.length){$cardTooltip.addClass("hide")}};const a=function(K){let $card=A(this).closest(".card");let $cardTooltip=$card.next("DIV.tooltip");if($cardTooltip.length){$cardTooltip.removeClass("hide")}};const d=function(K){if(!A.plugin.DirectoryUI.isFocusedClick(K)){return}let $item=A(K.currentTarget);let competenceId;if($item.hasClass("is-pinned")&&$item.hasClass("is-node")){return}else{if($item.hasClass("is-active")){if($item.data("esn-directory-parent-data-id")){competenceId=$item.data("esn-directory-parent-data-id")}else{competenceId=null}}else{competenceId=$item.data("jalios-data-id")||$item.closest(".esn-competencies-item").data("jalios-data-id")}}m(K,competenceId)};const o="plugins/ESNPlugin/jsp/directoryApp/contextmenu/doDirectoryContextMenu_competenceActions.jsp";const C=function(K){A(".competence-context-menu").hide()};const B=function(K){let $currentTarget=A(K.currentTarget);let catId=$currentTarget.data("jalios-data-id");if(!catId){return false}A.ajax({url:o,data:{ctxId:catId},type:"post"}).done(function(N){A("#competenceContextMenu .dropdown-menu").html(N);A("#competenceContextMenu").css({display:"block",top:0,left:0,right:"",bottom:""});A("#competenceContextMenu .dropdown-menu .divider:first-child").remove();A("#competenceContextMenu .dropdown-menu .divider:last-child").remove();A("#competenceContextMenu .dropdown-menu .divider + .divider").remove();var M=A("#competenceContextMenu").get(0);var L=e(M,K.pageX);var O=z(M,K.pageY);A("#competenceContextMenu").css({right:!L?0:"",left:!L?"":K.pageX,top:!O?"":K.pageY-i.documentElement.scrollTop,bottom:!O?0:""})});return false};const e=function(K,L){return L+K.offsetWidth<F.innerWidth};const z=function(K,L){return(L-i.documentElement.scrollTop+K.offsetHeight<F.innerHeight)};const r=function(K,L){A.jalios.ui.Modal.prompt(K,function(M){if(M===false){return}A.ajax({url:"plugins/ESNPlugin/jsp/directoryApp/doDirectoryApp_competenceHandler.jsp",data:{opCompetenceAdd:true,competenceParentId:L,competenceName:M}}).done(function(){A("FORM.app-directory-form").refresh({isform:true})})})};const H=function(L,M,K){A.jalios.ui.Modal.prompt(L,function(N){if(N===false){return}A.ajax({url:"plugins/ESNPlugin/jsp/directoryApp/doDirectoryApp_competenceHandler.jsp",data:{opCompetenceRename:true,competenceId:M,competenceName:N}}).done(function(){A("FORM.app-directory-form").refresh({isform:true})})},K)};const h=function(N,M,K){const L=function(){A.ajax({url:"plugins/ESNPlugin/jsp/directoryApp/doDirectoryApp_competenceHandler.jsp",data:{opCompetenceDelete:true,competenceId:M}}).done(function(){let $currentCompetenceIdInput=A("FORM.app-directory-form").find("input[name='competenceSearch_currentCompetenceId']");if($currentCompetenceIdInput.val()===M){$currentCompetenceIdInput.val(K)}A("FORM.app-directory-form").refresh({isform:true})})};A.jalios.ui.Modal.confirm(N,L)};const G=function(L,K){if(K){A.ajax({url:"plugins/ESNPlugin/jsp/directoryApp/doDirectoryApp_competenceHandler.jsp",data:{opCompetenceMove:true,competenceId:L,competenceParentId:K}}).done(function(){A("FORM.app-directory-form").refresh({isform:true})})}else{A.jalios.ui.Modal.openFromUrl("plugins/ESNPlugin/jsp/directoryApp/categories/moveToModal.jsp",{params:{competenceId:L}})}};const k=function(K){if(!A.plugin.DirectoryUI.isFocusedClick(K)){return}let $currentTarget=A(K.currentTarget);let action=$currentTarget.data("jalios-competence-action");let dataId=$currentTarget.data("jalios-data-id");let promptOrConfirmText=$currentTarget.data("jalios-text");if(!action||!dataId){return}C();K.stopPropagation();K.preventDefault();switch(action){case"add":r(promptOrConfirmText,dataId);break;case"rename":let currentCatName=$currentTarget.data("jalios-current-value");H(promptOrConfirmText,dataId,currentCatName);break;case"delete":let parentDataId=$currentTarget.data("jalios-parent-data-id");h(promptOrConfirmText,dataId,parentDataId);break;case"moveto":G(dataId);break;default:return}};const E=function(){f();n()};var y;const f=function(){var K=".esn-competencies-item-draggable";A(K).draggable({start:function(L,M){A(".app-directory-form").addClass("is-dragndropping");y=A(L.currentTarget);y.addClass("is-dragged");A(".competence-helper").text(" "+y.find(".js-title").text()).prepend(y.find(".js-icon").first().clone())},drag:function(M,L){},stop:function(L,M){A(".is-dragged").removeClass("is-dragged");y=l;A(".app-directory-form").removeClass("is-dragndropping")},containment:"body",scrollSensitivity:100,scrollSpeed:30,delay:150,appendTo:".app-body",helper:function(){return"<div class='competence-helper'></div>"},cursorAt:{left:5,top:0},cursor:"drag"})};const n=function(){var K=".esn-competencies-item:not(.esn-competencies-item-new-category), .breadcrumb-item-category";A(K).droppable({greedy:true,over:function(L,M){A(this).addClass("is-drag-hover")},drop:function(L,M){A(this).removeClass("is-drag-hover");let catId=y.data("jalios-data-id");let newParentCatId=A(L.target).data("jalios-data-id");G(catId,newParentCatId)},out:function(L,M){},tolerance:"pointer"})};const b=function(K,L){let clickedMenuItem=L.typeahead.$menu.find(".active");if(!(clickedMenuItem.hasClass("esn-competencies-item"))){if(A(clickedMenuItem).hasClass("ajax-refresh")){A(clickedMenuItem).find("A").refresh({noscroll:true,nohistory:true})}}else{let competenceId=clickedMenuItem.data("jalios-data-id");if(!competenceId){return true}m(K,competenceId)}};const p=function(K){if(!A.plugin.DirectoryUI.isFocusedClick(K)){return}let $item=A(K.currentTarget);let competenceId=$item.data("jalios-data-id");m(K,competenceId)};const u=function(K){if(!A.plugin.DirectoryUI.isFocusedClick(K)){return}let competenceId=A(this).data("jalios-data-id");if(competenceId){D(competenceId);if(A.plugin&&A.plugin.DirectoryApp&&typeof(A.plugin.DirectoryApp.refresh)==="function"){A.plugin.DirectoryApp.refresh.apply(null)}}};const m=function(L,K){let $form=A("FORM.app-directory-form");if(!$form.length){return}A(":INPUT[name=competenceSearch_currentCompetenceId]").val("");A(":INPUT[name=competenceSearch_currentCompetenceId]").each(function(M,N){let $elt=A(N);if(!$elt.val()){$elt.remove()}});if(K){let $input=A("<INPUT>").attr("name","competenceSearch_currentCompetenceId").attr("type","hidden").val(K);$form.append($input);let $opSearchInput=A("<INPUT>").attr("name",PARAM_OP_SEARCH).attr("type","hidden").val("true");$form.append($opSearchInput)}$form.refresh({isform:true})};const v=function(K){if(!A.plugin.DirectoryUI.isFocusedClick(K)){return}J(logPrefix,"[handleCategoryPinClick]",arguments.callee);K.stopImmediatePropagation();K.stopPropagation();K.preventDefault();let $item=A(K.currentTarget).closest(".esn-competencies-item");let competenceId=$item.data("jalios-data-id");if($item.hasClass("is-pinned")){J(logPrefix,"[handleCategoryPinClick]","Remove item",competenceId);D(competenceId)}else{J(logPrefix,"[handleCategoryPinClick]","Add item",competenceId);c(competenceId)}w(K)};const c=function(K){if(!K){return}J(logPrefix,"[addExpertiseFilter]","expertise",K,arguments.callee);let $form=A("FORM.app-directory-form");let $input=A("<INPUT>").attr("name",PARAM_NAME_COMPETENCE_ID).attr("type","hidden").val(K);$form.append($input)};const D=function(K){if(!K){return}J(logPrefix,"[removeExpertiseFilter]","expertise",K,arguments.callee);let $form=A("FORM.app-directory-form");let $pinnedInput=$form.find(':INPUT[name="'+PARAM_NAME_COMPETENCE_ID+'"][value="'+K+'"]');$pinnedInput.remove()};const w=function(L,K){let $item=A(L.currentTarget);let $form=$item.closest("FORM");if(!$form.length){return}if(K){let $input=A("<INPUT>").attr("name",PARAM_NAME_COMPETENCE_ID).attr("type","hidden").val(K);$form.append($input)}let $opSearchInput=A("<INPUT>").attr("name",PARAM_OP_SEARCH).attr("type","hidden").val("true");$form.append($opSearchInput);$form.refresh({isform:true})};const t=function(K){let refresh=A.jalios.Event.match(K,"refresh","after");if(!refresh||!refresh.target){return}q();E()};const J=function(){if(A.plugin&&A.plugin.DirectoryApp&&typeof(A.plugin.DirectoryApp.isDebugMode)==="function"){if(A.plugin.DirectoryApp.isDebugMode()&&typeof(A.plugin.DirectoryApp.consoleDebug)==="function"){A.plugin.DirectoryApp.consoleDebug.apply(null,Array.apply(null,arguments))}}else{let messages=[];Array.prototype.push.apply(messages,arguments);A.console.debug(logPrefix,messages)}};A(i).ready(function(){j()})}(jQuery,window,document));