var ImageUploader=function(a){if(!a||!a.inputElement||!a.inputElement.getAttribute||a.inputElement.getAttribute("type")!=="file"){throw new Error('Config object passed to ImageUploader constructor must include "inputElement" set to be an element of type="file"')}this.setConfig(a);var b=this;this.config.inputElement.addEventListener("change",function(e){$.log(new Date(),"fileInput reveiced change event");var d=[];var f=0;var c=$(b.config.inputElement).parent().next();if(c.hasClass("uploader-preview-wrapper")){c.remove()}for(;f<b.config.inputElement.files.length;++f){d.push(b.config.inputElement.files[f])}b.handleFileList(d,b.config.inputElement)},false)};ImageUploader.prototype.handleFileList=function(a,c){var d=this;if(a.length>1){var b=a.shift();this.handleFileSelection(b,c)}else{if(a.length===1){this.handleFileSelection(a[0],c)}}};ImageUploader.prototype.handleFileSelection=function(c,d){var b=document.createElement("img");this.currentFile=c;var a=new FileReader();var e=this;$.log(new Date(),"Showing loader");$(".ui-loader").loader("show");a.onload=function(f){$.log(new Date(),"Checking it is an image");if(f.target.result.split(",")[0].indexOf("data:image/")===-1){$.log(new Date(),"Not an image, hiding loader");$(".ui-loader").loader("hide");return}$.log(new Date(),"Creating fake image");b.src=f.target.result;setTimeout(function(){e.scaleImage(b,d,f.target.result)},1)};a.readAsDataURL(c)};ImageUploader.prototype.scaleImage=function(b,e,a){$.log(new Date(),"Begin scaleImage");if($(e).data("resize-quality-high")){var c=document.createElement("canvas");c.width=b.width;c.height=b.height;c.getContext("2d").drawImage(b,0,0,c.width,c.height);while(c.width>=2*this.config.maxWidth){$.log(new Date(),"Begin getHalfScaleCanvas iteration");c=this.getSimpleScaledCanvas(c,2)}if(c.width>this.config.maxWidth){$.log(new Date(),"Begin scaleCanvasWithAlgorithm iteration");c=this.scaleCanvasWithAlgorithm(c)}}else{$.log(new Date(),"Begin fast canvas resize");var f=b.width/this.config.maxWidth;var c=this.getSimpleScaledCanvas(b,f);$.log(new Date(),"End fast canvas resize")}$.log(new Date(),"Begin getAsJPEGBlob");var d=this.getAsJPEGBlob(c,e,a);$.log(new Date(),"End getAsJPEGBlob");if(d!=null){$(e).data("image-data-content",d);$(e).data("image-data-filename",e.files[0].name);$(e).parent().after('<div class="uploader-preview-wrapper"><span class="uploader-preview-clear ui-input-btn ui-btn ui-icon-delete ui-btn-icon-notext ui-corner-all"></span><img class="uploader-preview-thumbnail" src="'+c.toDataURL("image/jpeg",0.75)+'" />');$(e).parent().addClass("hide")}else{if($.jalios.smartPhone.isMobileApp()){if(a.split(",")[0].indexOf("data:image/jpeg;base64")>=0){$(".upload-image-action-container").append('<div class="imagepreview"><span class="icon-close ui-input-btn ui-btn ui-icon-delete ui-btn-icon-notext ui-corner-all"></span><img src="'+a+'" /></div>');$(".upload-image-action-icon").hide()}}}$(".ui-loader").loader("hide");$.log(new Date(),"Hiding loader")};ImageUploader.prototype.scaleCanvasWithAlgorithm=function(b){var e=document.createElement("canvas");var d=this.config.maxWidth/b.width;e.width=b.width*d;e.height=b.height*d;var c=b.getContext("2d").getImageData(0,0,b.width,b.height);var a=e.getContext("2d").createImageData(e.width,e.height);this.applyBilinearInterpolation(c,a,d);e.getContext("2d").putImageData(a,0,0);return e};ImageUploader.prototype.getSimpleScaledCanvas=function(a,c){var b=document.createElement("canvas");b.width=a.width/c;b.height=a.height/c;b.getContext("2d").drawImage(a,0,0,b.width,b.height);return b};ImageUploader.prototype.applyBilinearInterpolation=function(y,u,A){function z(g,D,b,j,a,E){var r=1-a;var i=1-E;return g*r*i+D*a*i+b*r*E+j*a*E}var q,o;var p,d,c,f,w,t;var e,n,C,m,B;var k,h;var l,s,v,x;for(q=0;q<u.height;++q){p=q/A;d=Math.floor(p);c=Math.ceil(p)>y.height-1?y.height-1:Math.ceil(p);for(o=0;o<u.width;++o){f=o/A;w=Math.floor(f);t=Math.ceil(f)>y.width-1?y.width-1:Math.ceil(f);e=(o+u.width*q)*4;n=(w+y.width*d)*4;C=(t+y.width*d)*4;m=(w+y.width*c)*4;B=(t+y.width*c)*4;k=f-w;h=p-d;l=z(y.data[n],y.data[C],y.data[m],y.data[B],k,h);u.data[e]=l;s=z(y.data[n+1],y.data[C+1],y.data[m+1],y.data[B+1],k,h);u.data[e+1]=s;v=z(y.data[n+2],y.data[C+2],y.data[m+2],y.data[B+2],k,h);u.data[e+2]=v;x=z(y.data[n+3],y.data[C+3],y.data[m+3],y.data[B+3],k,h);u.data[e+3]=x}}};ImageUploader.prototype.dataURItoBlob=function(b,g){var f;if(b.split(",")[0].indexOf("base64")>=0){f=atob(b.split(",")[1])}else{f=unescape(b.split(",")[1])}var a=b.split(",")[0].split(":")[1].split(";")[0];var e=new ArrayBuffer(f.length);var c=new Uint8Array(e);for(var d=0;d<f.length;d++){c[d]=f.charCodeAt(d)}return new Blob([e],{type:a})};ImageUploader.prototype.getAsJPEGBlob=function(c,d,b){var f=$(d).data("jalios-imageuploader-jpeg-quality")?$(d).data("jalios-imageuploader-jpeg-quality"):$["jalios-settings"]["imageuploader-default-jpeg-quality"];var e=c.toDataURL("image/jpeg",f);if(e==null||e===""||e==="data:,"){return null}if(b.split(",")[0].indexOf("data:image/jpeg;base64")>=0){e="data:image/jpeg;base64,"+ExifRestorer.restore(b,e)}var a=this.dataURItoBlob(e);return a};ImageUploader.prototype.setConfig=function(a){this.config=a;this.config.debug=this.config.debug||false;if(!this.config.maxWidth){this.config.maxWidth=1024}if(!this.config.workspace){this.config.workspace=document.createElement("div");document.body.appendChild(this.config.workspace)}};