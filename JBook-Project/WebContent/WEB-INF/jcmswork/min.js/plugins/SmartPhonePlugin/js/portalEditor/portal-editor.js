(function(e,h,i,b){if(!e.plugin){e.plugin={}}e.plugin.SmartphonePortalApp={getPortalEditor:function(){return d},getActivePortlet:function(){return d.getActiveSmartphonePortlet()},triggerEvent:function(m,o){var n=jQuery.Event("jalios.smartphone.portal");n.portalEditorEvent=m;n.portalEditorData=o;e(i).trigger(n)},getPortalId:function(){}};var d,j;var k=function(){d=new l(e(".mobile-portal-edition"))};var f=function(o,m,n){Object.defineProperty(a,m,{value:n,writable:false,enumerable:true,configurable:true})};var a={};f(a,"BLOCK_PORTLET",Handlebars.compile(e("#block-portlet-template").html()));f(a,"EMPTY_BLOCK_PORTLET",Handlebars.compile(e("#empty-block-portlet-template").html()));var g={saveTimer:null,createPortlet:function(o,m,p){var n=a.BLOCK_PORTLET({"portlet-id":o,image:p,name:m});return e(n)},createEmptyPortlet:function(m){let html=a.EMPTY_BLOCK_PORTLET({typeName:m});return e(html)},triggerCreatePortletEvent:function(m){e.plugin.SmartphonePortalApp.triggerEvent("create",{portlet:m,portletType:m.getType()})},updatePortalSidebarInputs:function(){var o=d.getUI();g.updateInputs(".portal-parameters",o);if(o!=null){g.updateInputs(".portal-parameters",o.css)}ace.require("ace/ext/language_tools");var n=ace.edit(e(".portal-custom-css").attr("id"));n.getSession().setMode("ace/mode/css");n.setAutoScrollEditorIntoView(true);n.getSession().setTabSize(2);n.getSession().setUseSoftTabs(true);n.setOption("maxLines",30);n.setOption("minLines",10);n.setOption("enableBasicAutocompletion",true);n.getSession().on("change",function(){var p=n.getSession().getValue();e(".ace-custom-css").val(p)});var m=ace.edit(e(".portal-custom-js").attr("id"));m.getSession().setMode("ace/mode/javascript");m.setAutoScrollEditorIntoView(true);m.getSession().setTabSize(2);m.getSession().setUseSoftTabs(true);m.setOption("maxLines",30);m.setOption("minLines",10);m.setOption("enableBasicAutocompletion",true);m.getSession().on("change",function(){var p=m.getSession().getValue();e(".ace-custom-js").val(p)})},updateInputs:function(o,m){try{e.each(m,function(q,r){if(typeof r==="boolean"||r=="true"||r=="false"){if(e(o+" INPUT[name='"+q+"']").length>1){e(o+" INPUT[name='"+q+"'][value='"+r+"']").prop("checked",true)}else{e(o+" INPUT[name='"+q+"']").prop("checked",r)}}else{if(e(o+" INPUT[name='"+q+"']").length){var p=e(o+" INPUT[name='"+q+"']");if(p.length>1&&p[0].type=="checkbox"&&!g.isEmpty(r)){e(p).each(function(s,t){if(r.indexOf(t.value)>-1){e(t).prop("checked",true)}})}else{e(o+" INPUT[name='"+q+"']").val(r)}}else{if(e(o+" SELECT[name='"+q+"']").length&&r!=null){e(o+" SELECT[name='"+q+"']").val(r)}else{if(e(o+" TEXTAREA[name='"+q+"']").length){e(o+" TEXTAREA[name='"+q+"']").val(r)}}}}})}catch(n){e.console.log(n)}},isEmpty:function(m){if(m==null||m==""||m==" "||m==b||m=="null"){return true}return false},updatePortalParametersFromSidebar:function(){g.updateJsonDataFromSidebar(".portal-parameters",d,"jalios-ui");g.updateJsonCssDataFromSidebar(".portal-parameters",d);g.triggerSavePortalTimer()},triggerSavePortalTimer:function(){if(g.saveTimer){clearTimeout(g.saveTimer)}g.saveTimer=setTimeout(g.savePortal,2000)},updateJsonDataFromSidebar:function(n,o,m){var p;if(o.$element.data(m)){p=o.$element.data(m)}else{p={}}e(n).find("INPUT, SELECT, TEXTAREA").not(".portal-css").each(function(r,u){var t=e(u).attr("NAME");var w=e(u).attr("TYPE");if(!g.isEmpty(t)){if(w=="radio"&&e(u).prop("checked")){p[t]=e(u).val()}else{if(w=="checkbox"){var v=e("INPUT[type='checkbox'][name='"+t+"']").length;if(v>1){var s=p[t];if(g.isEmpty(s)){s=[]}var q=e(u);var x=s.indexOf(q.val());if(x==-1&&q.is(":checked")){s.push(e(u).val());p[t]=s}else{if(x>-1&&!q.is(":checked")){s.splice(x,1)}}}else{p[t]=e(u).is(":checked")}}else{if(w!="radio"){p[t]=e(u).val()}}}}});o.$element.data(m,p);return p},updateJsonCssDataFromSidebar:function(p,o){var n={};e(p+" .portal-css").each(function(q,s){var r=e(s).attr("NAME");n[r]=e(s).val()});var m=o.$element.data("jalios-ui");m=m||{};m.css=n;o.$element.data("jalios-ui",m)},getStructure:function(){let portalStructure={};portalStructure.portlets=d.getAllportlets();portalStructure.ui=d.getUI();return JSON.stringify(portalStructure)},savePortal:function(m){clearTimeout(g.saveTimer);let structure=g.getStructure();if(structure===d.structure){return}d.structure=structure;e.plugin.SmartphonePortalApp.service.getInstance().savePortalStructure(d.getId(),structure,function(o){if(m){m()}g.updatePreview();var n=e.jalios.ui.Widget.Date.getDateFormat();var p=moment(new Date()).format(n);d.updateLastSaveDate(p)},function(n){})},updatePreview:function(){let $iframe=e("#smartphone-portal-preview");e(".edition-real").displayLoading();$iframe[0].src=$iframe[0].src}};var c=function(n,m,o){this.type=n;this.name=m;this.$element=g.createEmptyPortlet(this.name);o.replaceWith(this.$element);this.updateElementData();this.registerEvents();this.isEmpty=true};c.prototype.getType=function(){return this.type};c.prototype.getPortletId=function(){return this.portletId};c.prototype.updatePortlet=function(n,m,o){this.isEmpty=false;this.portletId=n;this.name=m;this.image=o;let $portlet=g.createPortlet(n,m,o);this.$element.replaceWith($portlet);this.$element=$portlet;this.updateElementData();this.registerEvents()};c.prototype.updatePreview=function(n,m,o){if(g.isEmpty(o)){o=this.image}this.updatePortlet(n,m,o);g.savePortal()};c.prototype.registerEvents=function(){let that=this;this.$element.find(".js-portlet-delete").on("click",function(m){e.jalios.ui.Modal.confirm(e(m.currentTarget).data("jalios-confirm-text"),function(){that.remove();d.initSortDrop();g.savePortal();if(that.isEmpty){e.plugin.SmartphonePortalApp.triggerEvent("cancelPortlet")}})})};c.prototype.remove=function(){this.$element.remove();d.initSortDrop()};c.prototype.getElement=function(){return this.$element};c.prototype.updateElementData=function(){this.$element.data("smartphone-portlet",this)};var l=function(m){this.$element=e(m);this.init()};l.prototype.init=function(){let that=this;this.isInitialized=false;this.displayOverlay();this.handlePendingOverlay(600);this.$editionBlocksBody=this.$element.find(".edition-blocks-body");this.$editionBlocks=this.$element.find(".edition-blocks");this.id=this.$element.data("jalios-portal-id");e.plugin.SmartphonePortalApp.service.getInstance().getPortalStructure(this.getId(),function(m){if(m&&m.data&&m.data.portlets){that.addPortlets(m.data.portlets)}that.initSortDrop();that.registerEvents();g.updatePortalSidebarInputs();that.isInitialized=true;that.structure=g.getStructure();e("#smartphone-portal-preview").on("load",function(){e(".edition-real .ajax-loading").remove()})},function(m){})};l.prototype.registerEvents=function(){let that=this;e(i).on("jalios:refresh",function(n){if(n.refresh&&n.refresh.type=="after"&&n.refresh.options){var m=n.refresh.options;if(m.params&&m.params.opUpdate=="true"){if(m.params.title){g.updatePreview()}if(m.params.portalStructureId){e(".history-selected .portal-history-item-title").text(m.params.customTitle);e.jalios.ui.Modal.close(true)}}if(m.params&&(m.params.returnToSidebarHome||m.params.opUpdate=="true")){that.initSortDrop();g.updatePortalSidebarInputs()}}});e(i).on("click","[data-smartphone-portal-action]",function(m){let $target=e(m.currentTarget);let action=$target.data("smartphone-portal-action");switch(action){case"display-history":that.displayHistory();break;case"remove-history":that.removeHistory();break;case"rename-history":that.openRenameVersionModal();break;case"history-revert":that.revertToOldVersion();break;case"load-history-item":that.loadHistoryItem($target);break;default:}});e(i).on("change paste keyup",".portal-parameters :input",function(m){g.updatePortalParametersFromSidebar()})};l.prototype.getUI=function(){let ui=this.$element.data("jalios-ui");if(ui===""){ui=null}return ui};l.prototype.revertToOldVersion=function(){event.preventDefault();event.stopPropagation();let that=this;e.jalios.ui.Modal.confirm(e("#portalHistoryIframe").data("jalios-confirm-text"),function(){let structureId=e(".portal-revert-form INPUT[name='structureId']").val();e.plugin.SmartphonePortalApp.service.getInstance().revertPortalStructure(d.getId(),structureId,function(m){h.location=h.location},function(m){console.log("errror")})})};l.prototype.openRenameVersionModal=function(){event.preventDefault();event.stopPropagation();let url="plugins/SmartPhonePlugin/jsp/portalEditor/doSmartphonePortalHistoryVersionRenameModal.jsp?portalStructureId=";let structureId=e(".portal-revert-form INPUT[name='structureId']").val();url+=structureId;e.jalios.ui.Modal.openFromUrl(url)};l.prototype.loadHistoryItem=function(m){e(".portal-history-revert").attr("disabled","disabled");e(".portal-history-item").removeClass("history-selected");var n=m.data("jalios-structure-id");var o=m.data("jalios-portal-url");m.addClass("history-selected");e(".js-portal-version-rename").attr("href","plugins/SmartphonePlugin/jsp/portalEditor/doSmartphonePortalHistoryVersionRenameModal.jsp?portalStructureId="+n);e("#portalHistoryIframe").off("load");e("#portalHistoryIframe").on("load",function(){e(".portal-history-revert").removeAttr("disabled")});e("#portalHistoryIframe").attr("src",o);e(".portal-revert-form INPUT[name='structureId']").val(n)};l.prototype.updateLastSaveDate=function(m){let $saveDate=this.$element.find(".portal-last-save-date");$saveDate.text(m);$saveDate.removeClass("hide")};l.prototype.displayHistory=function(){let that=this;this.displayOverlay();e.ajax({url:"plugins/SmartPhonePlugin/jsp/portalEditor/mobilePortalHistory.jsp",method:"post",data:{smartphonePortalId:that.getId()}}).done(function(m){e("BODY").append(m);that.scrollTop();e("BODY").addClass("portal-history-active");e(".portal-history-item").first().addClass("history-selected");e("#portalHistoryIframe").one("load",function(){that.hideOverlay()})})};l.prototype.removeHistory=function(){e(".portal-history").remove();e("BODY").removeClass("portal-history-active")};l.prototype.scrollTop=function(){this.$element.scrollTop(0);h.scrollTo(0,0)};l.prototype.handlePendingOverlay=function(m){let that=this;setTimeout(function(){if(that.isInitialized){e(".mobile-portal-edition").removeClass("hide");that.hideOverlay()}else{that.handlePendingOverlay(200)}},m)};l.prototype.displayOverlay=function(){e("BODY").addClass("portal-overlay-active");var m=e(".portal-overlay");m.removeClass("hide").addClass("is-active")};l.prototype.hideOverlay=function(){e("BODY").removeClass("portal-overlay-active");var m=e(".portal-overlay");m.one(e.support.transition.end,function(){m.addClass("hide")});m.removeClass("is-active")};l.prototype.addPortlets=function(m){if(m==b||m==null){return}let that=this;m.forEach(function(n){that.addPortlet(n)})};l.prototype.addPortlet=function(m){let $element=this.createEmptyElement();let smartphonePortlet=new c("","",$element);smartphonePortlet.updatePortlet(m.id,m.title,m.image)};l.prototype.getId=function(){return this.id};l.prototype.getAllportlets=function(){let portlets=[];this.$element.find(".portlet-block").each(function(m,n){let smartphonePortlet=e(n).data("smartphonePortlet");if(smartphonePortlet&&smartphonePortlet.getPortletId()){let portlet={};portlet.id=smartphonePortlet.getPortletId();portlets.push(portlet)}});return portlets};l.prototype.initSortDrop=function(){this.initSortable();this.initDragable()};l.prototype.getActiveSmartphonePortlet=function(){return this.activePortlet};l.prototype.initSortable=function(){let that=this;this.$editionBlocksBody.sortable({receive:function(m,n){let typeName=n.item.find(".js-type-name").text();let type=n.item.data("jalios-jmobile-portlet-class");let emptySmartphonePortlet=new c(type,typeName,n.helper);that.setActivePortlet(emptySmartphonePortlet);g.triggerCreatePortletEvent(emptySmartphonePortlet)},placeholder:"sortable-placeholder",tolerance:"pointer",stop:function(m,n){g.savePortal()}})};l.prototype.setActivePortlet=function(m){if(this.activePortlet&&this.activePortlet.isEmpty){this.activePortlet.remove()}this.activePortlet=m};l.prototype.initDragable=function(){this.$element.find(".js-smartphone-portlet").draggable({connectToSortable:".edition-blocks-body",cursorAt:{left:206,top:25},appendTo:"BODY",helper:function(){return"<div class='smartphone-portlet-helper'></div>"}})};l.prototype.createEmptyElement=function(){let $element=e("<div>");this.$editionBlocksBody.append($element);return $element};e(i).ready(function(){k();e("BODY").addClass("is-sidebar-opened")})})(jQuery,window,document);