!function(g){var a=false;var b=Typeahead.prototype.lookup;Typeahead.prototype.lookup=function(r){if(!this.options.ajax){return g.proxy(b,this)()}if(this.$element.data("autocomplete-lookup-event")){var v={typeahead:this,explicit:r,stop:false};g(this.$element).trigger(this.$element.data("autocomplete-lookup-event"),[v]);if(v.stop){return this}}else{if(this.$element.prop("tagName")=="TEXTAREA"){var t={type:"lookup",typeahead:this,explicit:r};Typeahead.hooks.fire(t);if(t.stop){return this}}else{this.query=this.$element.val()||"";var u=this.$element.attr("data-ac-lookup-empty")||false;if(this.query===""&&!u){return this.shown?this.hide():this}var q=this.$element.attr("data-ac-min-length")||g.jalios.Properties.get("autocomplete-min-chars");if(!u&&(this.query.length<q)){return this.hide()}}}var s=this;if(a){clearTimeout(a)}a=setTimeout(function(){k(s);a=false},g.jalios.Properties.get("autocomplete-chooser-timeout"));var p=this.$element.data("ac-lookup-pending-refresh");if(p){return this.show()}return this.hide()};var k=function(q){var p={url:q.options.ajax,params:{autocomplete:q.query},noscroll:true,nohistory:true,waiting:false,noerror:true,callback:function(){q.show()}};g.extend(true,p,q.options.ajaxOptions);q.$menu.refresh(p)};var o=Typeahead.prototype.click;Typeahead.prototype.click=function(p){if(p.target&&g(p.target).data("already-clicked")){return true}p.stopPropagation();p.preventDefault();this.select(undefined,p)};var j=Typeahead.prototype.select;Typeahead.prototype.select=function(u,z){if(a){clearTimeout(a)}if(this.$element.data("autocomplete-select-event")){var A={active:u,event:z,typeahead:this};g(document).trigger(this.$element.data("autocomplete-select-event"),[A]);return}var s=this.$element;var C=u||this.$menu.find(".active");var B=C.attr("data-value");if(z){var t=g(z.target);var D=t.hasClass("typeahead-ajax-refresh")?t:t.closest(".typeahead-ajax-refresh");if(D.exists()){var F={params:D.data("jalios-typeahead-options-params")};this.$menu.refresh(F);return}}if(C.hasClass("typeahead-layout")){return}if(C.is(".nomatch")){return this.hide()}var x=this;if(C.hasClass("ajax-refresh")){s.focus();C.find("A").refresh({noscroll:true,nohistory:true,callback:g.proxy(function(){var G=x.$menu.find("LI.select").first();if(G.exists()){x.select(G)}},x)});return this.show()}var r={type:"select",typeahead:this,$active:C};Typeahead.hooks.fire(r);if(!r.stop){if(B){g.proxy(j,this)()}else{if(C.exists()||(t&&t.closest(".typeahead-link").exists())){var y;if(z&&g(z.target).is("A")){y=g(z.target)}else{var w=z?g(z.target).closest("A.typeahead-link"):undefined;if(w&&w.exists()){y=w}else{y=C.find("A")}}if(!y){return}var q=y.prop("href");var E=y[0].protocol;if(!E){q=g(document).find("base").prop("href")+q}else{if(E.indexOf("http")<0){y.data("already-clicked",true);y.click()}}if(z&&z.which===2){var v=window.open(q,"_blank")}else{g.jalios.Browser.redirect(q,false,false)}}else{if(s[0]&&s[0].form){var p=s[0].form;if(p&&!g(p).hasClass("nosubmit-on-autocomplete")){p.submit()}}}}}var r=g.Event("jalios:autocomplete");r.autocomplete=this;r.autocomplete.value=B;g(document).trigger(r);return this.hide()};var f=Typeahead.prototype.keydown;Typeahead.prototype.keydown=function(p){if(p.keyCode!=9){this.$element.data("autocomplete-update",true)}if(p.keyCode==32&&p.ctrlKey){this.lookup(true);p.preventDefault();p.stopPropagation();return}g.proxy(f,this)(p)};var l=Typeahead.prototype.show;Typeahead.prototype.show=function(s){g.proxy(l,this)(s);if(!this.$element.is(":visible")){return this.hide()}if(this.$element.prop("tagName")!="TEXTAREA"){var r=this.$menu;var t=r.offset().left;var p=g(window).width()+g(window).scrollLeft();if(t+r.width()>p){r.find("UL").css("width",(p-t-20)+"px")}return this}var q={type:"show",typeahead:this};Typeahead.hooks.fire(q);return this};var c=Typeahead.prototype.blur;Typeahead.prototype.blur=function(q){var p=this;q.stopPropagation();q.preventDefault();setTimeout(function(){if(!p.$element.is(":focus")&&!p.$menu.is(":hover")){p.hide()}},150)};Typeahead.prototype.clear=function(p){};var h=Typeahead.prototype.next;Typeahead.prototype.next=function(p){g.proxy(h,this)(p);if(!this.$menu.find(".active").is(".typeahead-layout")){return}g.proxy(h,this)(p)};var e=Typeahead.prototype.prev;Typeahead.prototype.prev=function(p){g.proxy(e,this)(p);if(!this.$menu.find(".active").is(".typeahead-layout")){return}g.proxy(e,this)(p)};Typeahead.hooks=g.Callbacks();var m=function(){g(document).on("focusin",".typeahead[data-jalios-ajax-refresh-url]",n);g(document).on("jalios:refresh",i);g(document).on("click",d)};var d=function(q){var p=g(q.target);if(p.exists&&(p.hasClass("typeahead-menu")||p.hasClass("typeahead-input")||p.hasClass("typeahead-label")||p.parent().hasClass("typeahead-container"))){return}var r=g(".typeahead-menu");if(r.is(":visible")){r.hide()}};var i=function(q){var p=g.jalios.Event.match(q,"refresh","success");if(!p){return}if(p.target&&p.target.hasClass("typeahead-menu")){return}var r=g(".typeahead-menu");if(r.is(":visible")){r.hide()}};var n=function(s){var q=g(s.currentTarget);if(q.data("typeahead")){return}var r=g(q.data("ac-typeahead-menu"));if(!r.exists()){r=g('<div class="typeahead-menu ajax-refresh-div"></div>')}var p=q.attr("data-jalios-ajax-refresh-url");if(p){q.attr("autocomplete","off");q.typeahead({menu:r,ajax:p,ajaxOptions:q.data("jalios-options")})}};g(document).ready(function(p){m()})}(window.jQuery);