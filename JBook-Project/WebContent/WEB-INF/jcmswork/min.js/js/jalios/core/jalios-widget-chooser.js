!(function(g){var a=/(chooser):([\w-]+)/i;var n=/(widget):([\w-]+)/i;var m={acl:{path:g.jalios.Http.buildUrl("work/chooser/aclChooser.jsp"),name:"ACL"},category:{path:g.jalios.Http.buildUrl("work/categoryChooser.jsp?cids={value}"),name:"Category"},country:{path:g.jalios.Http.buildUrl("work/chooser/countryChooser.jsp"),name:"Country"},dbrecord:{path:g.jalios.Http.buildUrl("work/dbrecordChooser.jsp"),name:"DBRecord"},document:{path:g.jalios.Http.buildUrl("work/docChooser.jsp",{nbElt:"1"}),name:"Document"},group:{path:g.jalios.Http.buildUrl("work/chooser/groupChooser.jsp"),name:"Group"},image:{path:g.jalios.Http.buildUrl("work/mediaBrowser.jsp",{selectMode:"true",medias:"image"}),name:"Image",ref:"mediabrowser"},language:{path:g.jalios.Http.buildUrl("work/langChooser.jsp"),name:"Language"},media:{path:g.jalios.Http.buildUrl("work/mediaBrowser.jsp",{selectMode:"true"}),name:"Media",ref:"mediabrowser"},member:{path:g.jalios.Http.buildUrl("work/chooser/memberChooser.jsp"),name:"Member"},publication:{path:g.jalios.Http.buildUrl("work/pubChooser.jsp"),name:"Publication"},query:{path:g.jalios.Http.buildUrl("work/queryChooser.jsp",{qs:"{value}"}),name:"Query"},workspace:{path:g.jalios.Http.buildUrl("work/workspace/workspaceChooser.jsp"),name:"Workspace"},unifiedinsert:{path:"work/unifiedinsert/unifiedinsert.jsp?",name:"UnifiedInsert"}};var l=function(){g(document).on("jalios:broker",b);g(document).on("keyup",".duration_user",function(p){var o=g(p.currentTarget);f(o,1000)});g(document).on("change",".duration_unit",function(p){var o=g(p.currentTarget);f(o,1000)});g(document).on("change",".jalios-country",function(p){var o=g(p.currentTarget);o.prev("INPUT.jalios-country-display").removeClass(p.previousValue+"-flag").addClass(p.currentVal+"-flag")});g(document).on("change",".control-date",function(q){var p=g(q.currentTarget);j(p);var o={event:"change"};p.trigger(jQuery.Event("jalios.date.change",o))});g(document).on("focusout",':input[data-jalios-event="datechange"]',function(s){var u=g(this);var t=u.val();if(t){var o=u.closest(".datepicker-wrapper");var v=jQuery.jalios.I18N.glp("lang.datepicker");var p=o.closest(".widget").hasClass("jalios-date-time");var q=i(t,p,v);if(q){var r=i(o.data("date"),p,v);if(!r||r.getTime()!==q.getTime()){setTimeout(function(){var w={date:moment(q),event:"focusout"};u.trigger(jQuery.Event("datechange",w))},100)}}}});g(document).on("change",".form-control-value.jalios-workspace",function(p){var o=g(p.currentTarget);var s=o.closest(".widget");if(!s||!s.exists()){return}var r=s.find(".triggerWsChangeRefresh");if(!r||!r.exists()){return}var q=s.find(".workspaceChangeEvent");if(!q||!q.exists()){return}q.val(true);o.refresh()})};var b=function(C){var F=g.jalios.Event.match(C,"broker");if(!F){return}var v=F.type.match(a);var u=F.type.match(n);if(!(v||u)){return}var r=v?F.type.match(a):F.type.match(n);var w=r[1];var A=r[2];if(!w||!A){return}var B=g(F.source.currentTarget);var z=B.closest(".input-group-btn").find(".dropdown-menu");while(z.exists()&&z.hasClass("dropdown-menu")){z=z.parent();if(z.hasClass("dropdown-submenu")){z=z.parent()}}if(!z.exists()){z=B.parent()}var E=z.prevAll("INPUT.form-control-value");if(!E.exists()){E=z.prevAll("INPUT.form-control.control-file")}if(!E.exists()){E=B.closest(".control-file.plupload")}var q=F.options;if(m[A]){k(E,A,q,B)}else{if(A=="color"){try{if(!B.is("INPUT")){let $spectrumInput=B.closest(".input-group").find(".spectrum");$spectrumInput.spectrum("show")}}catch(s){g.console.log(s)}}else{if(A=="duration"){}else{if(A=="date"){if(!E.exists()&&B.is("INPUT")){E=B}c(B,E)}else{if(A=="clear"){g.jalios.ui.Widget.clear(E);try{if(!B.is("INPUT")){let $spectrumInput=B.closest(".input-group").find(".spectrum");if($spectrumInput.length){$spectrumInput.spectrum("set","")}}}catch(s){g.console.log(s)}if(E.hasClass("jalios-country")&&!E.val()){var p=E.prev(".control-country");var x=p[0].className.match(/\w*-flag/g);if(x){for(var D=0;D<x.length;D++){p.removeClass(x[D])}p.addClass("-flag")}}if(E.data("jalios-event")==="datechange"){var q={event:"clear"};E.trigger(jQuery.Event("datechange",q))}if(E.hasClass("jalios-publication")){var y=g.jalios.ui.Widget.getWidget(E);if(y.exists()){var o=E.closest(".jalios-input-group");var t=o.find(".jalios-publication-filebrowser");if(t.exists()){t.prop("disabled",y.hasClass("disabled"));t.attr("disabled",null);t.removeClass("hide");o.find("INPUT.form-control-display").addClass("hide").prop("disabled",true);o.find("INPUT.form-control-value").addClass("hide").prop("disabled",true)}}}}else{if(B.attr("data-jalios-chooser")){q.customId=A;k(E,B.attr("data-jalios-chooser"),q,B)}}}}}}};var k=function(q,u,t,o){var v=function(z,K,A,y){var G=q.parent();var J=G.find("INPUT.form-control-display");if(J.exists()){var F=q.val();q.val(z||"").trigger(jQuery.Event("change",{previousValue:F,currentVal:z}));var B=J.val();J.val(K||"").trigger(jQuery.Event("change",{previousValue:B,currentVal:K}))}else{var E=q.val();q.val(y||"").trigger(jQuery.Event("change",{previousValue:E,currentVal:y}))}var D=G.find(".jalios-publication-filebrowser");if(D.exists()){D.addClass("hide");if(D.is(":input")){D.prop("disabled",true)}else{D.find('INPUT[type="file"]').prop("disabled",true)}J.removeClass("hide");J.prop("disabled",false);q.prop("disabled",false)}if(q.hasClass("jalios-publication")&&z){var x=g.jalios.ui.Widget.Keyword.isInKeyword(q);if(!x){var H=G.find(".input-group-btn");var I=H.find(".dropdown-toggle");if(I.exists()){g.fn.dropdown.clearMenus();var C=H.find(".dropdown-menu");C.find(".edit-item").removeClass("hide");C.find(".add-item").addClass("hide")}}}var w=q.closest(".widget");if(w.exists()&&w.hasClass("keyword")){JCMS.form.Widget.add(J[0])}};var p={currentValue:q.val(),params:t,popup:{}};if(o.data("jalios-chooser-popup-width")){p.popup.width=o.data("jalios-chooser-popup-width")}if(o.data("jalios-chooser-popup-height")){p.popup.height=o.data("jalios-chooser-popup-height")}var s=q.closest(".edit-pub,#jalios-modal,form");if(!p.params.ws&&!p.params.workspaceFilter&&s.exists()&&u!=="group"&&u!=="member"){var r=s.find(':input[name="ws"]');if(r.exists()){p.params.ws=r.val()}}if(p.params.customId==="edit"){delete p.params.ws}g.jalios.ui.Widget.Chooser.openDataChooser(u,v,p)};var c=function(o,r){var p=o.closest(".datepicker-wrapper");if(!p.data("DateTimePicker")){var s=jQuery.jalios.I18N.glp("lang.datepicker");var q=p.closest(".widget").hasClass("jalios-date-time");p.datetimepicker({locale:s,format:d(!q),calendarWeeks:true,stepping:1,widgetParent:g(document.body),keyBinds:{left:null,right:null,"delete":null},icons:{time:"glyphicons-clock",date:"glyphicons-calendar",up:"glyphicons-chevron-up",down:"glyphicons-chevron-down",previous:"glyphicons-chevron-left",next:"glyphicons-chevron-right",today:"glyphicons-screenshot",clear:"glyphicons-trash"}}).on("dp.change",function(u){var t={date:u.date,oldDate:u.oldDate,event:"change"};j(p);r.trigger(jQuery.Event("jalios.date.change",t))}).on("dp.hide",function(u){var t={date:u.date,event:"hide"};j(p);if(u.date){r.trigger(jQuery.Event("datechange",t))}})}p.data("DateTimePicker").show()};g.jalios.ui.Widget.Chooser={openDataChooser:function(p,v,s){var s=s||{};s.currentValue=s.currentValue||"";s.params=s.params||{};var v=v||function(w){};var r,u,q;if(m[p]){r=m[p]["ref"]||p;u=m[p].path;q=m[p].name}else{r=s.params.customId||"custom";u=p;q="Custom"}u=u.replace(new RegExp(encodeURIComponent("{value}")),encodeURIComponent(s.currentValue));u=g.jalios.Http.buildUrl(u,s.params);u=g.jalios.Http.getContextPath()+"/"+u;s=g.extend(true,{popup:{width:1080,height:600}},s);var t=s.popup.width;var o=s.popup.height;g.jalios.Browser.popupWindow(u,q,t,o,false,true,true,false,false,v)}};var j=function(u){var q=jQuery.jalios.I18N.glp("lang.datepicker");var r=jQuery(u).closest(".datepicker-wrapper").addBack(".datepicker-wrapper");var y=r.closest(".widget");var A=y.hasClass("jalios-date-time");var z=r.find(".form-control-display");var p=r.find(".form-control-value");if(!z.exists()){return}var x=z.data("timezone");var o=p.data("timezone");var s=z.val();var t=moment.tz(s,d(!A),x);if(t.isValid()){var v=t.clone().tz(o);var w=v.format(d(!A));p.val(w)}};var i=function(s,o,r){var p;if(s){var q=moment(s,d(!o),r||I18N["lang.datepicker"],true);if(q.isValid()){p=q.toDate()}}return p};var e=function(p,o,r){var q;if(p){q=moment(p).locale(r||I18N["lang.datepicker"]).format(d(!o))}return q};var d=function(o){return I18N.glp(o?"datechooser.js.date-format":"datechooser.js.date-time-format")};var h=function(q){var r=q.closest(".widget").hasClass("jalios-date-time");var s=q.val();if(!s){return}var o=parseInt(s);var p=new Date(o);q.val(e(p,r))};var f=function(o,q){var u=g.jalios.ui.Widget.getWrapper(o);var s=u.find("INPUT.duration");var r=u.find("INPUT.duration_user");var p=u.find("SELECT.duration_unit");if(!r.exists()){return}r.val(r.val().replace(/[^0-9\.]/,""));var t=r.val()?parseInt(Math.round(r.val()))*parseInt(p.val()):"";s.val(t)};g.jalios.ui.Widget.Date={stringToDate:i,dateToString:e,getDateFormat:d,updateDuration:f,updateDate:h,openDateChooser:c};g(document).ready(function(o){l()})})(window.jQuery);