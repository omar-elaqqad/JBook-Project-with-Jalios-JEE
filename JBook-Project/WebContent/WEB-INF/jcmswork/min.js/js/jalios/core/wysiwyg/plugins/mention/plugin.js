(function(b){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=b(require("jquery"))}else{if(typeof define==="function"&&define.amd){define(["jquery"],b)}else{var a;if(typeof window!=="undefined"){a=window}else{if(typeof global!=="undefined"){a=global}else{if(typeof self!=="undefined"){a=self}else{a=this}}}b(a.jQuery)}}})(function(b){var c="&#xFEFF;";var a=function(d,e){this.editor=d;this.options=b.extend({},{source:[],delay:500,queryBy:"name",items:10},e);this.options.insertFrom=this.options.insertFrom||this.options.queryBy;this.matcher=this.options.matcher||this.matcher;this.sorter=this.options.sorter||this.sorter;this.renderDropdown=this.options.renderDropdown||this.renderDropdown;this.render=this.options.render||this.render;this.insert=this.options.insert||this.insert;this.highlighter=this.options.highlighter||this.highlighter;this.query="";this.hasFocus=true;this.renderInput();this.bindEvents()};a.prototype={constructor:a,renderInput:function(){var d='<span id="autocomplete"><span id="autocomplete-delimiter">'+this.options.delimiter+'</span><span id="autocomplete-searchtext">'+c+c+"</span></span>";this.editor.execCommand("mceInsertContent",false,d);this.editor.selection.setCursorLocation(this.editor.selection.dom.select("span#autocomplete-searchtext")[0],1)},bindEvents:function(){this.editor.on("keyup",this.editorKeyUpProxy=b.proxy(this.rteKeyUp,this));this.editor.on("keydown",this.editorKeyDownProxy=b.proxy(this.rteKeyDown,this),true);this.editor.on("click",this.editorClickProxy=b.proxy(this.rteClicked,this));b("body").on("click",this.bodyClickProxy=b.proxy(this.rteLostFocus,this));b(this.editor.getWin()).on("scroll",this.rteScroll=b.proxy(function(){this.cleanUp(true)},this))},unbindEvents:function(){this.editor.off("keyup",this.editorKeyUpProxy);this.editor.off("keydown",this.editorKeyDownProxy);this.editor.off("click",this.editorClickProxy);b("body").off("click",this.bodyClickProxy);b(this.editor.getWin()).off("scroll",this.rteScroll)},rteKeyUp:function(f){switch(f.which||f.keyCode){case 40:case 38:case 16:case 17:case 18:break;case 8:if(this.query===""){this.cleanUp(true)}else{this.lookup()}break;case 9:case 13:var d=(this.$dropdown!==undefined)?this.$dropdown.find("li.active"):[];if(d.length){this.select(d.data());this.cleanUp(false)}else{this.cleanUp(true)}break;case 27:this.cleanUp(true);break;default:this.lookup()}},rteKeyDown:function(d){switch(d.which||d.keyCode){case 9:case 13:case 27:d.preventDefault();break;case 38:d.preventDefault();if(this.$dropdown!==undefined){this.highlightPreviousResult()}break;case 40:d.preventDefault();if(this.$dropdown!==undefined){this.highlightNextResult()}break}d.stopPropagation()},rteClicked:function(f){var d=b(f.target);if(this.hasFocus&&d.parent().attr("id")!=="autocomplete-searchtext"){this.cleanUp(true)}},rteLostFocus:function(){if(this.hasFocus){this.cleanUp(true)}},lookup:function(){this.query=b.trim(b(this.editor.getBody()).find("#autocomplete-searchtext").text());if(this.$dropdown===undefined){this.show()}clearTimeout(this.searchTimeout);this.searchTimeout=setTimeout(b.proxy(function(){var d=b.isFunction(this.options.source)?this.options.source(this.query,b.proxy(this.process,this),this.options.delimiter):this.options.source;if(d){this.process(d)}},this),this.options.delay)},matcher:function(d){return ~d[this.options.queryBy].toLowerCase().indexOf(this.query.toLowerCase())},sorter:function(f){var g=[],e=[],d=[],h;while((h=f.shift())!==undefined){if(!h[this.options.queryBy].toLowerCase().indexOf(this.query.toLowerCase())){g.push(h)}else{if(~h[this.options.queryBy].indexOf(this.query)){e.push(h)}else{d.push(h)}}}return g.concat(e,d)},highlighter:function(d){return d.replace(new RegExp("("+this.query.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")+")","ig"),function(e,f){return"<strong>"+f+"</strong>"})},show:function(){var d=this.editor.inline?this.offsetInline():this.offset();this.$dropdown=b(this.renderDropdown()).css({top:d.top,left:d.left});b("body").append(this.$dropdown);this.$dropdown.on("click",b.proxy(this.autoCompleteClick,this))},process:function(f){if(!this.hasFocus){return}var g=this,d=[],e=b.grep(f,function(h){return g.matcher(h)});e=g.sorter(e);e=e.slice(0,this.options.items);b.each(e,function(j,k){var h=b(g.render(k,j));h.html(h.html().replace(h.text(),g.highlighter(h.text())));b.each(e[j],function(i,l){h.attr("data-"+i,l)});d.push(h[0].outerHTML)});if(d.length){this.$dropdown.html(d.join("")).show()}else{this.$dropdown.hide()}},renderDropdown:function(){return'<ul class="rte-autocomplete dropdown-menu"><li class="loading"></li></ul>'},render:function(e,d){return'<li><a href="javascript:;"><span>'+e[this.options.queryBy]+"</span></a></li>"},autoCompleteClick:function(f){var d=b(f.target).closest("li").data();if(!b.isEmptyObject(d)){this.select(d);this.cleanUp(false)}f.stopPropagation();f.preventDefault()},highlightPreviousResult:function(){var d=this.$dropdown.find("li.active").index(),e=(d===0)?this.$dropdown.find("li").length-1:--d;this.$dropdown.find("li").removeClass("active").eq(e).addClass("active")},highlightNextResult:function(){var d=this.$dropdown.find("li.active").index(),e=(d===this.$dropdown.find("li").length-1)?0:++d;this.$dropdown.find("li").removeClass("active").eq(e).addClass("active")},select:function(e){this.editor.focus();var d=this.editor.dom.select("span#autocomplete")[0];this.editor.dom.remove(d);this.editor.execCommand("mceInsertContent",false,this.insert(e))},insert:function(d){return"<span>"+d[this.options.insertFrom]+"</span>&nbsp;"},cleanUp:function(e){this.unbindEvents();this.hasFocus=false;if(this.$dropdown!==undefined){this.$dropdown.remove();delete this.$dropdown}if(e){var h=this.query,d=b(this.editor.dom.select("span#autocomplete"));if(!d.length){return}var g=b("<p>"+this.options.delimiter+h+"</p>")[0].firstChild,f=b(this.editor.selection.getNode()).offset().top===(d.offset().top+((d.outerHeight()-d.height())/2));this.editor.dom.replace(g,d[0]);if(f){this.editor.selection.select(g);this.editor.selection.collapse()}}},offset:function(){var f=b(this.editor.getContainer()).offset(),d=b(this.editor.getContentAreaContainer()).position(),e=b(this.editor.dom.select("span#autocomplete")).offset();return{top:f.top+d.top+e.top+b(this.editor.selection.getNode()).innerHeight()-b(this.editor.getDoc()).scrollTop()+5,left:f.left+d.left+e.left}},offsetInline:function(){var d=b(this.editor.dom.select("span#autocomplete")).offset();return{top:d.top+b(this.editor.selection.getNode()).innerHeight()+5,left:d.left}}};tinymce.create("tinymce.plugins.Mention",{init:function(d){var e,f=d.getParam("mentions");f.delimiter=(f.delimiter!==undefined)?!b.isArray(f.delimiter)?[f.delimiter]:f.delimiter:["@"];f.triggerRegex=(f.triggerRegex!==undefined)?typeof f.triggerRegex==="string"?new RegExp(f.triggerRegex,"g"):f.triggerRegex:/[!"\#$%&'()*+,\-./:;<=>?\[\\\]^_`{|}~\s]{1}$/g;f.canTriggerAutocomplete=(f.canTriggerAutocomplete!==undefined)?f.canTriggerAutocomplete:function(i){var h=i.selection.getRng(true);var g=h.startOffset!==h.endOffset;if(g){return true}if(h.startOffset===0){return true}var k=h.startContainer.data||"";var j=f.triggerRegex.test(k);f.triggerRegex.lastIndex=0;return j};d.on("keypress",function(g){var h=b.inArray(String.fromCharCode(g.which||g.keyCode),f.delimiter);if(h>-1&&f.canTriggerAutocomplete(d)){if(e===undefined||(e.hasFocus!==undefined&&!e.hasFocus)){g.preventDefault();e=new a(d,b.extend({},f,{delimiter:f.delimiter[h]}))}}})},getInfo:function(){return{longname:"mention",author:"Steven Devooght",version:tinymce.majorVersion+"."+tinymce.minorVersion}}});tinymce.PluginManager.add("mention",tinymce.plugins.Mention)});