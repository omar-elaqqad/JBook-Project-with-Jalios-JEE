!function(a){tinymce.PluginManager.add("jcms",function(g,d){var l=[];var n=[];var c=[];var f={};g.jcms={getContext:function(){return g.jcms.context||{}},getWysiwygEditorInfos:function(){return g.jcms.wysiwygEditorInfos||{}},getPluginDataInfos:function(q,p){var o=f[q]||[];var r=o[p];if(!r){a.ajax({url:"js/jalios/core/wysiwyg/plugins/jcms/jsp/pluginInfos.jsp",data:{pluginId:q,dataId:p},async:false,dataType:"json",success:function(s){if(s&&s.dataId){r=s;g.jcms.setPluginDataInfos(q,p,r)}},error:function(u,v,s){var t=v+", "+s;a.console.log("Request Failed: "+t)}})}return r||{}},setPluginDataInfos:function(q,p,r){var o=f[q];if(!o){o=[];f[q]=o}o[p]=r},getMediaInfos:function(p){var o=n[p];if(!o){a.ajax({url:"js/jalios/core/wysiwyg/plugins/jcms/jsp/mediaInfos.jsp",data:{source:p},async:false,dataType:"json",success:function(q){if(q&&q.source){o=q;g.jcms.setMediaInfos(o)}},error:function(s,t,q){var r=t+", "+q;a.console.log("Request Failed: "+r)}})}return o||{}},setMediaInfos:function(o){n[o.source]=o},getMemberInfos:function(o){var p=c[o];if(!p){a.ajax({url:"jcore/autocomplete/acmention.jsp",data:{memberId:o},async:false,dataType:"json",success:function(q){if(q.length>0){p=q[0];g.jcms.setMemberInfos(p)}},error:function(s,t,q){var r=t+", "+q;a.console.log("Request Failed: "+r)}})}return p||{}},setMemberInfos:function(o){c[o.id]=o}};g.on("PreInit",function(){var r=a(g.getElement());var s=jQuery("html");var x=jQuery(g.getDoc()).find("html");x.attr("lang",s.attr("lang"));x.attr("xml:lang",s.attr("xml:lang"));var v=jQuery(g.getBody());v.attr("lang",r.attr("lang"));v.attr("xml:lang",r.attr("xml:lang"));var o=r.data();g.jcms.context=a.extend({},o,{getWorkspace:function(){var A=g.jcms.context.workspace;var C=r.closest(".edit-pub");if(C.exists()){var B=C.find(':input[name="ws"]');if(B.exists()){A=B.val()||A}}return A}});var y;try{var z=r.closest(".wysiwyg-editor").find(".wysiwyg-editor-infos");var u=z.exists()?z[0].value:"{}";y=u===null||u===""?{}:a.parseJSON(u)}catch(t){a.console.log("Could not parse wysiwyg-editor-infos",r,u,t)}if(y){g.jcms.wysiwygEditorInfos=y;var w=y.dataInfos;if(w){for(var q=0;q<w.length;q++){var p=w[q];if(p.type==="Member"){g.jcms.setMemberInfos(p)}else{g.jcms.setMediaInfos(p)}}}}});g.ui.registry.addContextMenu("quickimage",{update:function(o){return["image"]}});g.on("LoadContent",function(){let $editorBody=a(g.getBody());let block_formats=g.settings.block_formats;let block_formats_defined=block_formats&&block_formats!=="";let hasH1InConf=block_formats_defined&&block_formats.indexOf("h1")!==-1;let hasH2InConf=block_formats_defined&&block_formats.indexOf("h2")!==-1;let hasH1=$editorBody.find("H1").exists();let migrateHeaders=!hasH1InConf&&hasH2InConf&&hasH1;if(!migrateHeaders){return}for(var o=6;o>0;o--){let newHeaderLevel=o+1;let headers=$editorBody.find("H"+o);headers.each(function(){var q=a(this).get();var p=g.dom.create((newHeaderLevel<7)?"h"+(newHeaderLevel):"div",g.dom.getAttribs(q));g.dom.replace(p,q,true);if(newHeaderLevel>=7){g.dom.setAttribs(p,{role:"heading","aria-level":newHeaderLevel})}})}});g.ui.registry.addToggleButton("spellchecker",{icon:"spell-check",tooltip:"Spellcheck",disabled:true,onAction:function(){g.ui.registry.getAll().buttons.onAction()},onSetup:function(p){var o=g.ui.registry.getAll().buttons.spellchecker.onSetup();var r=function(){p.setDisabled(true)};var q=function(){p.setDisabled(false)};g.on("PostRender",r);g.on("Focus",q);g.on("Blur",r);return function(s){g.off("PostRender",r);g.off("Focus",q);g.off("Blur",r);o()}}});var h="";g.on("SpellcheckStart",function(){h=g.settings.contextmenu;g.settings.contextmenu="spellchecker"});g.on("SpellcheckEnd",function(){g.settings.contextmenu=h});g.on("PostProcess",function(o){if(o.get&&!o.selection){o.content=j(o.content)}});function j(p){if(!p){return""}if(p.match(/^(<p[^>]*>(&nbsp;|&#160;|\s|\u00a0|<br \/>|)<\/p>[\r\n]*|<br \/>[\r\n]*)$/)){return p}if(p.trim().match(/^<div class="[^"]*wysiwyg[^"]*"/)){return p}var o='<div class="wysiwyg">'+p+"</div>";return o}g.on("BeforeSetContent",function(o){if(o.set&&!o.selection){o.content=b(o.content)}});function b(o){if(!o){return""}var p=o.match(/^<div class="[^"]*wysiwyg[^"]*">([^]*)<\/div>$/);if(p){return p[1]}return o}function m(p){if(!p){return""}var o=new RegExp("<(jalios:[^\\s]+)(.*?)/>","gi");return p.replace(o,"<$1$2></$1>")}g.on("PastePreProcess",function(o){o.content=b(o.content);o.content=m(o.content)});g.on("BeforeSetContent",function(o){o.content=i(o.content)});function i(p){var o=new RegExp("(<jalios:[^\\s/>]+)([ />])","gi");return p.replace(o,function(r,q,s){if(k(r)){return r}return q+' contenteditable="false"'+s})}g.on("PostProcess",function(o){if(o.get){o.content=e(o.content)}});function e(p){var o=new RegExp('(<jalios:[^\\s/>]+)(.*) contenteditable="[^"]+"',"gi");return p.replace(o,function(r,q,s){if(k(r)){return r}return q+s})}function k(o){for(var p=0;p<l.length;p++){if(o.startsWith("<"+l[p])){return true}}return false}})}(window.jQuery);