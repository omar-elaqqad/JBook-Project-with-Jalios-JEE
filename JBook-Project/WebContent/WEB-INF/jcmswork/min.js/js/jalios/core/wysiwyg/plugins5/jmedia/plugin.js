!function(a){tinymce.PluginManager.add("jmedia",function(f,g){var t="jalios:media";var e="data-jalios-source";var p="iframe";var n="img";var r="data-jalios-media-source";var l="data-mce-p-"+r;var j="jcore/media/embed.jsp";var s=f.getParam("media_template","<"+t+"@attributes@ />");var i=f.getParam("media_placeholder","<"+p+'@attributes@ contenteditable="false"></'+p+">");var h=f.getParam("media_img_placeholder","<"+n+"@attributes@ />");var q=a.wysiwyg.utils.getTagRegExp(t,e);var o=a.wysiwyg.utils.getTagRegExp(p,r);var b=a.wysiwyg.utils.getTagRegExp(n,r);f.jalios.plugins.jmedia={insertTag:function(u){var v=f.jalios.plugins.jmedia.createTag(u);f.insertContent(v)},createTag:function(v){var u=" "+e+'="'+a.wysiwyg.utils.escape(v.source)+'"';u+=v.width?' data-jalios-width="'+v.width+'"':"";u+=v.height?' data-jalios-height="'+v.height+'"':"";u+=v.title?' data-jalios-title="'+a.wysiwyg.utils.escape(v.title)+'"':"";u+=v.style?' data-jalios-style="'+a.wysiwyg.utils.escape(v.style)+'"':"";u+=v.classes?' data-jalios-class="'+a.wysiwyg.utils.escape(v.classes)+'"':"";return s.replace(/@attributes@/g,u)},createHtmlTag:function(x){var w=j+"?autoresize=true&src="+encodeURIComponent(x.source)+(x.width?"&width="+x.width:"")+(x.height?"&height="+x.height:"");if(x.type==="image"){w=x.url}var u=' src="'+a.wysiwyg.utils.escape(w)+'" '+r+'="'+a.wysiwyg.utils.escape(x.source)+'" data-mce-src="'+a.wysiwyg.utils.escape(w)+'"';if(x.width){u+=' width="'+x.width+'"';x.classes=((x.classes||"").replace(/\s*is-width-set/gi,"")+" is-width-set").trim()}if(x.height){u+=' height="'+x.height+'"';x.classes=((x.classes||"").replace(/\s*is-height-set/gi,"")+" is-height-set").trim()}u+=x.title?' title="'+a.wysiwyg.utils.escape(x.title)+'" alt="'+a.wysiwyg.utils.escape(x.title)+'"':"";u+=x.style?' style="'+a.wysiwyg.utils.escape(x.style)+'"':"";u+=x.classes?' class="'+a.wysiwyg.utils.escape(x.classes)+'"':"";var v=x.type==="image"?h:i;return v.replace(/@attributes@/g,u)}};f.ui.registry.addIcon("jmedia",'<span class="jalios-icon icomoon-film4"></span>');f.ui.registry.addToggleButton("jmedia",{tooltip:tinymce.i18n.translate("jmedia.btn.tooltip"),icon:"jmedia",onAction:c,onSetup:function(u){const v=function(w){u.setActive(k(w.element))};f.on("NodeChange",v);return function(w){f.off("NodeChange",v)}}});f.addCommand("JaliosInsert-media",function(x,v){if(!v){return}var w=v["data-jalios-source"];var u=f.jcms.getMediaInfos(w);if(u&&u.source){f.jalios.plugins.jmedia.insertTag(u)}});f.on("ResolveName",function(v){var u=v.target;if(k(u)){v.name="jalios:media"}});f.on("BeforeSetContent",function(u){u.content=d(u.content)});f.on("PostProcess",function(u){if(u.get){u.content=m(u.content)}});function k(u){return(u.nodeName.toUpperCase()===p.toUpperCase()&&f.dom.getAttrib(u,r))||(u.nodeName.toUpperCase()===n.toUpperCase()&&f.dom.getAttrib(u,r))||(u.nodeName.toUpperCase()==="SPAN"&&f.dom.hasClass(u,"mce-object-iframe")&&f.dom.getAttrib(u,l))}function c(){a.jalios.ui.Widget.Chooser.openDataChooser("media",u,{params:{ws:f.jcms.getContext().getWorkspace()}});function u(z,B,A,x,y,w){var v={source:z,title:B,type:A,url:x,width:y,height:w};f.jcms.setMediaInfos(v);f.jalios.plugins.jmedia.insertTag(v)}}function d(u){return u.replace(q,function(x,w){var z=a(x);var A=z.attr(e);var y=f.jcms.getMediaInfos(A);var B=/^\w+_\w+$/.match(A);var C=B&&(!y||y.source===y.url);if(y&&y.source&&!C){var v={source:A,width:z.attr("data-jalios-width"),height:z.attr("data-jalios-height"),title:z.attr("data-jalios-title"),style:z.attr("data-jalios-style"),classes:z.attr("data-jalios-class")};v=a.extend({},y,v);return f.jalios.plugins.jmedia.createHtmlTag(v)}else{return x}})}function m(u){u=u.replace(o,function(w,v){var x=a(w);return f.jalios.plugins.jmedia.createTag({source:x.attr(r),width:x.width(),height:x.height(),title:x.attr("title"),style:x.attr("style"),classes:x.attr("class")})});u=u.replace(b,function(w,v){var x=a(w);return f.jalios.plugins.jmedia.createTag({source:x.attr(r),width:x.attr("width"),height:x.attr("height"),title:x.attr("alt")||x.attr("title"),style:x.attr("style"),classes:x.attr("class")})});return u}})}(window.jQuery);