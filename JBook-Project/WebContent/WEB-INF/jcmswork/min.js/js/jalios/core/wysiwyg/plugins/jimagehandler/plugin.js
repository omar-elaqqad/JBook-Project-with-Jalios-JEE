!function(a){tinymce.PluginManager.add("jimagehandler",function(d,b){var c="jalios-uploaded-image";var e="<img[^>]*"+c+"[^>]*>";d.jalios.plugins.jimagehandler={uploadImages:function(f,o,h,g,m){var j=function(r){var q=f.blobUri();if(q&&m){jQuery(m.getBody()).find("img[src='"+f.blobUri()+"']").remove()}return h(r)};var p,i;var n=m.settings.images_upload_url||"js/jalios/core/wysiwyg/plugins/jimagehandler/jsp/uploadImage.jsp";var k={url:a.jalios.Http.buildUrl(n,{ws:m.jcms.getContext().getWorkspace()}),credentials:m.settings.images_upload_credentials||true,basePath:m.settings.images_upload_base_path||JcmsJsContext.getBaseUrl()};var l=function(r,q){if(r){return r.replace(/\/$/,"")+"/"+q.replace(/^\//,"")}return q};p=new XMLHttpRequest();p.open("POST",k.url);p.withCredentials=k.credentials;p.upload.onprogress=function(q){g(q.loaded/q.total*100)};p.onerror=function(){j("Image upload failed due to a XHR Transport error. Code: "+p.status)};p.onload=function(){var q;if(p.status<200||p.status>=300){j("HTTP Error: "+p.status);return}q=JSON.parse(p.responseText);if(!q){h("Invalid JSON: "+p.responseText);return}if(q.message){j(q.message);return}o(l(k.basePath,q.location))};i=new window.FormData();i.append("file",f.blob(),f.filename());p.send(i)}};d.on("PastePreProcess",function(h){var g=h.content;if(g.startsWith("<img")){var f=a(g);h.content=f.addClass(c).prop("outerHTML")}});d.on("BeforeSetContent",function(h){var g=h.content;if(g.startsWith("<img")&&g.indexOf("?source=")>=0){var f=a(g);h.content=f.addClass(c).prop("outerHTML")}});d.on("PostProcess",function(g){var f=new RegExp(e,"gi");g.content=g.content.replace(f,function(h){var k=a(h);var j=k.attr("src");var l=a.jalios.Http.toQueryParams(j);var i={source:l.source||j,width:k.attr("width"),height:k.attr("height"),title:k.attr("alt")||k.attr("title"),style:k.attr("style")};return d.jalios.plugins.jmedia.createTag(i)})})})}(window.jQuery);